const express = require('express');
const https = require('https');
const fs = require('fs');
const cors = require('cors'); // Importa el paquete CORS
const router = express.Router();

class Engine {
    constructor() {
        this.registryFileName = "/home/lpv24/Escritorio/SD/SD/Groso/BD.json"; // Ruta del archivo JSON del registro
        this.idsVerificados = [];
    }

    verificarToken(token) {
        try {
            if (fs.existsSync(this.registryFileName)) {
                const data = fs.readFileSync(this.registryFileName, 'utf8');
                const registryData = JSON.parse(data);
                for (const droneAlias in registryData) {
                    if (registryData[droneAlias].token === token) {
                        this.idsVerificados.push(registryData[droneAlias].id); // Guardar el ID verificado
                        console.log(this.idsVerificados);
                        return { message: "Token válida", droneAlias };
                    }
                }
                return { error: "Token no válida" };
            } else {
                return { error: "El archivo JSON del registro no existe o está vacío" };
            }
        } catch (err) {
            console.error('Error al leer el archivo JSON:', err);
            return { error: "Error al verificar la token" };
        }
    }

    obtenerIDsVerificados() {
        return this.idsVerificados;
    }

    leerMapaDesdeJSON() {
        try {
            if (fs.existsSync(this.registryFileName)) {
                const data = fs.readFileSync(this.registryFileName, 'utf8');
                const mapa = JSON.parse(data).mapa; // Suponiendo que 'mapa' es la clave donde está el mapa en BD.json
                return mapa;
            } else {
                throw new Error("El archivo JSON del registro no existe o está vacío");
            }
        } catch (err) {
            console.error('Error al leer el archivo JSON:', err);
            return null;
        }
    }

    procesarMapa() {
        const mapa = this.leerMapaDesdeJSON();
        if (!mapa) {
            return null;
        }
        const posicionesNoCero = [];
        for (let i = 0; i < mapa.length; i++) {
            for (let j = 0; j < mapa[i].length; j++) {
                if (mapa[i][j] !== 0) {
                    posicionesNoCero.push([i, j, mapa[i][j][0][0], mapa[i][j][2]]); // Agrega la posición al array si no es igual a cero
                }
            }
        }
        return posicionesNoCero;
    }
}

const engine = new Engine();

router.post('/verificar_dron', (req, res) => {
    const { token } = req.body;
    if (!token) {
        return res.status(400).json({ error: "Falta el token del dron" });
    }

    const resultado = engine.verificarToken(token);
    res.json(resultado);
});

router.get('/ids_verificados', (req, res) => {
    const idsVerificados = engine.obtenerIDsVerificados();
    res.json({ idsVerificados });
});

router.get('/obtener_mapa', (req, res) => {
    const datosMapaProcesado = engine.procesarMapa(); // Obtén el mapa procesado
    res.json({ datosMapaProcesado });
});

const app = express();
app.use(express.json());
app.use(cors()); // Agrega el middleware de CORS
app.use('/', router);

const options = {
    key: fs.readFileSync('key.pem'),
    cert: fs.readFileSync('cert.pem')
};

const PORT = process.env.PORT || 3001; // Puerto para la API del motor

const server = https.createServer(options, app);

server.on('error', (error) => {
    console.error('Error al iniciar el servidor:', error);
});

server.listen(PORT, () => {
    console.log(`Servidor HTTPS del motor escuchando en el puerto ${PORT}`);
});
